#!/bin/bash

run_logged() {
  # Show command name
  local display="${1//_/ }"
  local display="${display^}"
  printf "%-40s " "$display"

  local logfile=/tmp/dotfiles.log

  printf "[%s] %s\n" "$(date -u '+%Y-%m-%d %H:%M:%S')" "$display" >>$logfile
  eval "$1" &>>$logfile

  case "$?" in
    0) printf "\033[32m%s\033[0m\n" "ok" ;;
    125) printf "\033[34m%s\033[0m\n" "skipped" ;;
    *) printf "\033[31m%s\033[0m\n" "failed" ;;
  esac
}

share_links() {
  mkdir -p ~/.config
  find "$DOTFILES"/config -mindepth 1 -maxdepth 1 -type d | while read -r path; do
    rm -fr ~/.config/"$(basename "$path")"
    ln -snf "$path" ~/.config/"$(basename "$path")"
  done;
}

update_config_caches() {
  bat cache --build
}

install_tmux_package_manager() {
  if [[ ! -d ~/.config/tmux/plugins/tpm ]]; then
    git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm
  else
    # Operation canceled
    return 125
  fi
}

append_dotfiles_bashrc() {
  BASHRC="source $DOTFILES/config/bashrc"
  if ! grep -q "$BASHRC" ~/.bashrc; then
    echo "$BASHRC" >> ~/.bashrc
  else
    return 125
  fi
}

# Clear log file if exist
rm -fr /tmp/dotfiles.log

# Run steps
run_logged share_links
run_logged update_config_caches
run_logged install_tmux_package_manager
run_logged append_dotfiles_bashrc

printf "\n\033[90m%s\033[0m\n" "See detailed logs on '/tmp/dotfiles.log'"
