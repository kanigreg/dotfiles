#!/bin/bash

# Bitwarden Secret Manager wrapper over dockerized CLI

cli() {
  docker run --rm -it -e BWS_ACCESS_TOKEN="$BWS_ACCESS_TOKEN" bitwarden/bws:latest "$@" \
    | grep -v "Permission denied" \
    | grep -v "Retrieving the state file failed"
}

tsv_list() {
  cli secret list --output tsv --color no | tail -n +2
}

retrieve_secret () {
   tsv_list | grep "$1" | cut -f 3
}

usage() {
  cat <<EOF
To get list of available keys
Example:
  - bws key_list

For create secret pass <KEY> <VALUE> [<DESCRIPTION>]
Examples:
  - bws create <KEY> <VLAUE>
  - bws create <KEY> <VLAUE> <DESCRIPTION>

Pass secret <KEY> to get <VLAUE>
Example:
  - bws <KEY>
EOF
}

cmd_or_key="$1"
shift

case $cmd_or_key in
  config|complations|project|secret|run|help) cli "$cmd_or_key" "$@" ;;
  key_list) tsv_list | cut -f 2 | sort ;;
  create) cli secret create "$1" "$2" "$BWS_PROJECT_PERSONAL" --note "$3" ;;
  "") cli help ;;
  *) if [[ $# == 0 ]]; then retrieve_secret "$cmd_or_key"; else usage; fi ;;
esac
